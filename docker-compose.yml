services:
  # pbf_fetcher:
  #   image: curlimages/curl:8.10.1
  #   container_name: pbf_fetcher
  #   command: >
  #     sh -lc "
  #       set -euo pipefail;
  #       echo '[pbf_fetcher] Downloading ${OSM_PBF_URL} -> /data/${PBF_NAME}';
  #       curl -L --fail --max-time 3600 --connect-timeout 30 -C - --output /data/${PBF_NAME}.tmp '${OSM_PBF_URL}';
  #       mv /data/${PBF_NAME}.tmp /data/${PBF_NAME};
  #       ls -lh /data/${PBF_NAME};
  #       echo '[pbf_fetcher] Done.'
  #     "
  #   env_file: .env
  #   volumes:
  #     - ${OSRM_DATA}:/data
  #   restart: "no"

  osrm:
    image: ghcr.io/project-osrm/osrm-backend:latest
    container_name: osrm
    # depends_on:
    #   pbf_fetcher:
    #     condition: service_completed_successfully
    volumes:
      - ${OSRM_DATA}:/data
      - ${OSRM_DATA}/profiles:/profiles:ro
    command: osrm-routed --max-matching-size 1000 --max-table-size 1000 --max-viaroute-size 1000 --algorithm mld /data/${OSRM_BASE}.osrm
    env_file: .env
    ports:
      - "5000:5000"

  tile_import:
    image: overv/openstreetmap-tile-server:latest
    container_name: tile_import
    user: "root"
    # depends_on:
    #   pbf_fetcher:
    #     condition: service_completed_successfully
    volumes:
      - ${OSRM_DATA}:/data
      - tiles-db:/var/lib/postgresql/15/main
      - tiles-cache:/var/cache/renderd
      - ./tile-import-wrapper.sh:/tile-import-wrapper.sh:ro
    environment:
      UPDATES: "disabled"
      THREADS: "4"
      # Memory for osm2pgsql (4GB cache, slim mode, drop intermediate tables)
      OSM2PGSQL_EXTRA_ARGS: "-C 4096 --slim --drop"
    env_file: .env
    entrypoint: /bin/bash /tile-import-wrapper.sh
    restart: "no"

  tile_server:
    image: overv/openstreetmap-tile-server:latest
    container_name: osmtiles
    user: "root"
    depends_on:
      tile_import:
        condition: service_completed_successfully
    volumes:
      - ${OSRM_DATA}:/data
      - tiles-db:/var/lib/postgresql/15/main
      - tiles-cache:/var/cache/renderd
    environment:
      UPDATES: "disabled"
      THREADS: "4"
    env_file: .env
    command: "run"
    ports:
      - "8090:80"

  frontend:
    image: nginx:alpine
    container_name: demo_frontend
    depends_on:
      - osrm
      - tile_server
      - avoidzones
    volumes:
      - ./frontend:/usr/share/nginx/html
    ports:
      - "8081:80"

  avoidzones:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: avoidzones
    depends_on:
      - osrm
    environment:
      OSRM_PROFILE: ${OSRM_PROFILE}
      PBF_NAME: ${PBF_NAME}
      OSRM_BASE: ${OSRM_BASE}
      AVOIDZONES_TOKEN: ${AVOIDZONES_TOKEN}
      OSM_PBF_URL: ${OSM_PBF_URL}
      REFRESH_CRON_HOUR: ${REFRESH_CRON_HOUR:-2}
      AVOIDZONE_INSIDE_FACTOR: ${AVOIDZONE_INSIDE_FACTOR:-0.02}
      AVOIDZONE_TOUCH_FACTOR: ${AVOIDZONE_TOUCH_FACTOR:-0.10}
    volumes:
      - ${OSRM_DATA}:/data
      - ${OSRM_DATA}/profiles:/profiles:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  tiles-db:
  tiles-cache:
