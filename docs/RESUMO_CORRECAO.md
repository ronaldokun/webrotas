# Resumo da Corre√ß√£o - Sistema de Zonas de Evitar (Avoid Zones)\n\n## Problema Encontrado\n\nO sistema de zonas de evitar **n√£o estava funcionando** porque todo o c√≥digo de reprocessamento do arquivo PBF estava comentado/desabilitado em `app.py`.\n\n### O que estava acontecendo:\n- ‚úÖ As configura√ß√µes de pol√≠gonos eram salvas\n- ‚úÖ O container OSRM era reiniciado\n- ‚ùå **O arquivo PBF nunca era modificado com as penalidades**\n- ‚ùå **As rotas nunca eram afetadas pelas zonas de evitar**\n\n## Por que n√£o funcionava?\n\nO perfil Lua (`car_avoid.lua`) **n√£o consegue verificar dinamicamente** se uma via intersecta com pol√≠gonos porque:\n- O hook `process_way()` do OSRM **n√£o fornece as coordenadas dos n√≥s**\n- O perfil s√≥ consegue ler tags que j√° existem no arquivo PBF\n- Sem reprocessar o PBF para adicionar tags de `avoid_zone` e `avoid_factor`, o perfil n√£o tem dados para trabalhar\n\n## Como Funciona Agora\n\nO sistema usa uma **abordagem em 3 est√°gios**:\n\n### 1Ô∏è‚É£ Reprocessamento do PBF (Python)\nO m√≥dulo `cutter.py` l√™ o arquivo PBF original e:\n1. Carrega os pol√≠gonos do GeoJSON\n2. Varre todas as vias (ways) de rodovia\n3. Usa STRtree do Shapely para busca espacial eficiente\n4. Para cada via, calcula se est√°:\n   - **Completamente dentro de um pol√≠gono** ‚Üí penalidade INSIDE_FACTOR (0.02 = 2% da velocidade)\n   - **Tocando a borda do pol√≠gono** ‚Üí penalidade TOUCH_FACTOR (0.10 = 10% da velocidade)\n5. Salva um novo PBF com as tags de penalidade adicionadas\n\n### 2Ô∏è‚É£ Reprocessamento do OSRM\nAp√≥s modificar o PBF:\n1. Executa `osrm-extract` (extrai as features do PBF)\n2. Executa `osrm-partition` (particiona o grafo)\n3. Executa `osrm-customize` (otimiza para roteamento)\n4. Reinicia o container OSRM para carregar os novos dados\n\n### 3Ô∏è‚É£ Aplica√ß√£o das Penalidades (Lua)\nO perfil `car_avoid.lua` durante o roteamento:\n- Verifica se a via tem a tag `avoid_zone=yes`\n- Se tiver, multiplica a velocidade da via pelo `avoid_factor`\n- Uma via com velocidade 100 km/h e fator 0.02 vira 2 km/h\n- O roteador OSRM naturalmente evita vias muito lentas\n\n## Mudan√ßas Realizadas\n\n### 1. Habilitado Reprocessamento do PBF (`app.py`, linhas 340-374)\n- Descomentado todo o pipeline de reprocessamento\n- Agora quando voc√™ submete zonas de evitar, o sistema:\n  1. Modifica o PBF com as penalidades\n  2. Reprocessa com OSRM\n  3. Reinicia o OSRM\n  4. Valida que tudo funcionou\n\n### 2. Adicionado curl ao Docker (`Dockerfile`)\n- Adicionado `curl` √† imagem final (produ√ß√£o)\n- Fixes: O health check agora funciona corretamente\n- O container consegue executar verifica√ß√µes de sa√∫de\n\n### 3. Fixado Permiss√µes do Container (`docker-compose.yml`)\n- Adicionado `user: \"root\"` ao servi√ßo avoidzones\n- Necess√°rio para acessar o socket do Docker e reiniciar o OSRM\n\n### 4. Aumentado Tempo de Inicializa√ß√£o do Health Check\n- Mudado de 5s para 30s\n- D√° mais tempo para o servi√ßo se estabilizar\n\n## Fatores de Penalidade\n\n- **INSIDE_FACTOR = 0.02** (2%)\n  - Aplicado quando a via est√° completamente dentro da zona\n  - Muito restritivo - desencorajas fortemente passar por l√°\n  - Uma via de 100 km/h vira 2 km/h\n\n- **TOUCH_FACTOR = 0.10** (10%)\n  - Aplicado quando a via toca ou cruza a borda da zona\n  - Moderadamente restritivo - permite passar mas penaliza\n  - Uma via de 100 km/h vira 10 km/h\n\n## Testando\n\nPara testar se est√° funcionando:\n\n```bash\n# 1. Aplicar um pol√≠gono de teste\ncurl -X POST http://localhost:9090/avoidzones/apply \\\n  -H \"Authorization: Bearer Melancia-sem1-Caro√ßo\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"type\": \"FeatureCollection\",\n    \"features\": [{\n      \"type\": \"Feature\",\n      \"geometry\": {\n        \"type\": \"Polygon\",\n        \"coordinates\": [[[-43.5, -23.5], [-43.4, -23.5], [-43.4, -23.4], [-43.5, -23.4], [-43.5, -23.5]]]\n      }\n    }]\n  }'\n\n# 2. Monitorar os logs\ndocker compose logs -f avoidzones\n\n# Voc√™ deve ver:\n# - \"Applying penalties to PBF...\"\n# - \"Running osrm-extract...\"\n# - \"Running osrm-partition...\"\n# - \"Running osrm-customize...\"\n# - \"Restarting OSRM container...\"\n\n# 3. Comparar rotas antes e depois\n# As rotas devem mudar significativamente, desviando das zonas\n```\n\n## Importante\n\n‚è±Ô∏è **Tempo**: O primeiro reprocessamento pode levar 5-30 minutos (depende do tamanho do PBF e hardware)\n\nüíæ **Mem√≥ria**: Requer 8GB+ de RAM durante o processamento\n\nüîÑ **Atualiza√ß√£o**: Depois de aplicar zonas, n√£o pode ser em tempo real - requer reprocessamento completo do PBF\n\nüìÅ **Persist√™ncia**: As configura√ß√µes de zonas s√£o salvas em hist√≥rico - voc√™ pode reverter para vers√µes anteriores\n\n## Locais dos Arquivos\n\n- **PBF Original**: `/media/ronaldo/Homelab/webrotas/region.osm.pbf`\n- **PBF Modificado**: `/media/ronaldo/Homelab/webrotas/region_avoidzones.osm.pbf`\n- **Dados OSRM**: `/media/ronaldo/Homelab/webrotas/region_avoidzones.osrm*`\n- **Hist√≥rico**: `/media/ronaldo/Homelab/webrotas/avoidzones_history/`\n- **Configura√ß√£o Atual**: `/media/ronaldo/Homelab/webrotas/latest_avoidzones.geojson`\n"}}
