# Client-Side Avoid Zones: Implementation Roadmap  <br><br>## Overview  <br><br>This document provides a step-by-step implementation checklist for migrating from server-side PBF reprocessing to client-side avoid zones filtering.  <br><br>**Timeline**: 2-4 weeks  \n**Risk Level**: Low (parallel deployment, no breaking changes)  \n**Team Size**: 1-2 developers  <br><br>---  <br><br>## Phase 1: Server-Side Infrastructure (Week 1)  <br><br>### 1.1 New Route Wrapper Endpoint  <br><br>- [ ] Add `GET /route/v1/driving/{coordinates}` endpoint to `app.py`\n- [ ] Implement `check_route_intersections()` helper function\n- [ ] Implement `load_zones_version()` helper function\n- [ ] Implement `load_spatial_index()` helper function\n- [ ] Add query parameters:\n  - [ ] `zones_version` (optional, default: \"latest\")\n  - [ ] `avoid_mode` (\"filter\" or \"penalize\")\n  - [ ] `alternatives` (number of routes)\n  - [ ] `token` (optional for public access)  <br><br>#### Code Checklist  <br><br>```python\n# In src/webrotas/app.py\n\n# Add imports\nfrom shapely.geometry import LineString, shape\nfrom shapely.strtree import STRtree\nimport httpx\n\n# Add constants\nOSRM_URL = os.getenv(\"OSRM_URL\", \"http://localhost:5000\")\n\n# Implement helpers\ndef check_route_intersections(coords, polygons, tree):\n    \"\"\"See main research doc for full implementation\"\"\"\n    pass\n\ndef load_zones_version(version_id):\n    \"\"\"See main research doc for full implementation\"\"\"\n    pass\n\ndef load_spatial_index(geojson):\n    \"\"\"See main research doc for full implementation\"\"\"\n    pass\n\n# Add endpoint\n@app.get(\"/route/v1/driving/{coordinates}\")\nasync def route_with_zones(coordinates: str, ...):\n    \"\"\"See main research doc for full implementation\"\"\"\n    pass\n```  <br><br>**Validation**:\n- [ ] Endpoint accepts valid OSRM coordinates format\n- [ ] Returns OSRM response structure unchanged\n- [ ] Adds `penalties` and `zones_applied` fields\n- [ ] Handles missing zone files gracefully\n- [ ] Tests with 1, 3, 10+ polygon avoid zones  <br><br>### 1.2 OSRM Proxy Handler  <br><br>- [ ] Implement async HTTP client for OSRM requests\n- [ ] Handle OSRM errors (routing failures, timeouts)\n- [ ] Pass through OSRM alternatives parameter\n- [ ] Add timeout handling (30-60s)  <br><br>```python\nasync def request_osrm(url: str, alternatives: int = 1, overview: str = \"full\", geometries: str = \"geojson\"):\n    \"\"\"Request route from OSRM with parameters.\"\"\"\n    async with httpx.AsyncClient(timeout=60) as client:\n        response = await client.get(\n            url,\n            params={\n                \"alternatives\": alternatives,\n                \"overview\": overview,\n                \"geometries\": geometries\n            }\n        )\n        response.raise_for_status()\n        return response.json()\n```  <br><br>**Validation**:\n- [ ] Can reach OSRM on port 5000\n- [ ] Parses OSRM response correctly\n- [ ] Handles network timeouts\n- [ ] Returns proper error codes  <br><br>### 1.3 Unit Tests for Intersection Logic  <br><br>- [ ] Create `tests/test_client_side_zones.py`\n- [ ] Test route fully inside zone (penalty > 0.9)\n- [ ] Test route touching zone boundary (0.1 < penalty < 0.9)\n- [ ] Test route outside zone (penalty = 0)\n- [ ] Test multiple polygon intersections\n- [ ] Test edge cases (empty route, no zones)  <br><br>```bash\n# Run tests\nuv run pytest tests/test_client_side_zones.py -v\n```  <br><br>**Validation**:\n- [ ] All intersection tests pass\n- [ ] Penalty scores in expected ranges\n- [ ] Edge cases handled without crashes  <br><br>---  <br><br>## Phase 2: Frontend Integration (Week 1-2)  <br><br>### 2.1 UI Components  <br><br>- [ ] Add zone version selector dropdown\n- [ ] Add avoid mode selector (filter/penalize)\n- [ ] Display zone metadata (version, polygon count, timestamp)\n- [ ] Show penalty scores for each route variant\n- [ ] Add route color coding by penalty (green/orange/red)\n- [ ] Display dashed line for routes with intersections  <br><br>#### HTML Updates  <br><br>```html\n<!-- In frontend/index.html -->\n<div class=\"sec\">\n    <strong>Avoid Zones Settings</strong><br>\n    <div>Zones Version: \n        <select id=\"zones-version\">\n            <option value=\"latest\">Latest</option>\n        </select>\n    </div>\n    <div>Avoid Mode:\n        <select id=\"avoid-mode\">\n            <option value=\"penalize\">Penalize (score routes)</option>\n            <option value=\"filter\">Filter (exclude routes in zones)</option>\n        </select>\n    </div>\n    <div id=\"zones-info\" style=\"font-size: 0.85em; color: #666; margin-top: 8px;\"></div>\n</div>\n```  <br><br>**Checklist**:\n- [ ] Selectors have sensible defaults\n- [ ] Zone version dropdown populates from history\n- [ ] UI responsive on mobile screens\n- [ ] No console errors on page load  <br><br>### 2.2 Route Visualization  <br><br>- [ ] Implement `routeWithZones()` async function\n- [ ] Implement `visualizeRoutePenalties()` function\n- [ ] Color routes by penalty score\n- [ ] Show penalty information in popups\n- [ ] Sort routes by penalty (best first)\n- [ ] Handle multiple route variants  <br><br>```javascript\n// Key functions to implement\nasync function routeWithZones(start, end, zonesVersion, avoidMode) { ... }\nfunction visualizeRoutePenalties(map, route, penalties) { ... }\nfunction updateZonesInfo(zonesApplied) { ... }\n```  <br><br>**Checklist**:\n- [ ] Routes display with correct colors\n- [ ] Penalty popups show correct values\n- [ ] Multiple routes sorted by score\n- [ ] Zone version shown in UI\n- [ ] Alternatives parameter passed correctly  <br><br>### 2.3 History Dropdown Integration  <br><br>- [ ] Load history list when page loads\n- [ ] Populate zones-version dropdown with history items\n- [ ] Format dropdown labels (timestamp, file size)\n- [ ] Support \"Latest\" as special option\n- [ ] Add refresh button for history  <br><br>```javascript\nasync function populateZonesHistory() {\n    const versions = document.getElementById('zones-version');\n    const response = await fetch(`${API_URL}/avoidzones/history`, { \n        headers: authHeaders() \n    });\n    const history = await response.json();\n    \n    // Add historical versions\n    history.forEach(item => {\n        const option = document.createElement('option');\n        option.value = item.filename.replace('.geojson', '').replace('avoidzones_', '');\n        option.textContent = `${item.ts} (${item.size} bytes)`;\n        versions.appendChild(option);\n    });\n}\n```  <br><br>**Checklist**:\n- [ ] History loads on page initialization\n- [ ] Dropdown shows 5-20 most recent configs\n- [ ] Latest appears first in list\n- [ ] Timestamp formatting is readable\n- [ ] No crashes on empty history  <br><br>---  <br><br>## Phase 3: Testing & Validation (Week 2)  <br><br>### 3.1 Integration Tests  <br><br>- [ ] Create `tests/integration_test_client_zones.py`\n- [ ] Test full route request with zones\n- [ ] Verify response structure\n- [ ] Check penalty calculations\n- [ ] Test zone version switching\n- [ ] Test filter vs penalize modes  <br><br>```bash\n# Setup test environment\nuv run pytest tests/integration_test_client_zones.py -v -s\n```  <br><br>**Test Cases**:  <br><br>| Test | Expected Behavior | Status |\n|------|------------------|--------|\n| Route with no zones | Returns OSRM response unchanged | [ ] |\n| Route crossing 1 zone | Penalty 0.3-0.7 (50% in zone) | [ ] |\n| Route fully in zone | Penalty > 0.9 | [ ] |\n| Route avoiding zone | Penalty = 0 | [ ] |\n| Filter mode with zones | Routes in zones excluded | [ ] |\n| Penalize mode with zones | All routes returned, scored | [ ] |\n| Invalid zone version | Returns 404 or latest | [ ] |\n| Multiple alternatives | Returns 3 routes, all scored | [ ] |  <br><br>### 3.2 Performance Benchmarks  <br><br>- [ ] Create `tests/benchmark_client_zones.py`\n- [ ] Measure single route filtering latency\n- [ ] Test with 1, 5, 10, 50+ zones\n- [ ] Measure spatial index creation time\n- [ ] Test with 100-1000 coord routes\n- [ ] Compare vs server-side approach  <br><br>```bash\n# Run benchmarks\nuv run pytest tests/benchmark_client_zones.py::test_latency_1_zone -v\nuv run pytest tests/benchmark_client_zones.py::test_latency_10_zones -v\nuv run pytest tests/benchmark_client_zones.py::test_latency_50_zones -v\n```  <br><br>**Target Performance**:  <br><br>| Scenario | Target | Status |\n|----------|--------|--------|\n| Single zone, 100-coord route | <50ms | [ ] |\n| 10 zones, 500-coord route | <100ms | [ ] |\n| 50 zones, 1000-coord route | <200ms | [ ] |\n| Spatial index creation | <5ms per zone | [ ] |  <br><br>### 3.3 End-to-End Testing  <br><br>**Manual Testing Checklist**:  <br><br>1. **UI Responsiveness**\n   - [ ] Load frontend on desktop\n   - [ ] Load frontend on mobile\n   - [ ] Check dropdown behavior\n   - [ ] Verify no console errors  <br><br>2. **Routing Flow**\n   - [ ] Route with latest zones\n   - [ ] Route with historical zones\n   - [ ] Switch between filter/penalize modes\n   - [ ] Verify route colors change with penalty\n   - [ ] Check popup shows penalty data  <br><br>3. **Edge Cases**\n   - [ ] Route when no zones defined\n   - [ ] Route when zones deleted\n   - [ ] Create new zones, route with them immediately\n   - [ ] Revert to old zones, verify routing\n   - [ ] Request with invalid zone version  <br><br>4. **Concurrency**\n   - [ ] Open 2 browser tabs, route simultaneously\n   - [ ] Verify no resource contention\n   - [ ] Check server response times unchanged\n   - [ ] Monitor CPU/memory usage  <br><br>---  <br><br>## Phase 4: Documentation & Migration (Week 3)  <br><br>### 4.1 API Documentation  <br><br>- [ ] Document new `/route/v1/driving/{coordinates}` endpoint\n- [ ] List all query parameters with examples\n- [ ] Document response schema\n- [ ] Add example cURL requests\n- [ ] Document error codes  <br><br>```markdown\n## GET /route/v1/driving/{coordinates}\n\nRoute with optional avoid zones filtering.\n\n### Parameters\n- `coordinates` (required): OSRM format \"lng1,lat1;lng2,lat2\"\n- `zones_version` (optional): \"latest\" or \"avoidzones_YYYYMMDD_HHMMSS\"\n- `avoid_mode` (optional): \"filter\" or \"penalize\" (default: \"penalize\")\n- `alternatives` (optional): Number of routes (1-3)\n\n### Example\n```bash\ncurl -H \"Authorization: Bearer token\" \\\n  'http://localhost:9090/route/v1/driving/-46.70,-23.55;-46.63,-23.55?zones_version=latest&avoid_mode=penalize&alternatives=3'\n```\n```  <br><br>**Checklist**:\n- [ ] API docs in `docs/API.md`\n- [ ] Example requests for each mode\n- [ ] Response schema documented\n- [ ] Error responses documented  <br><br>### 4.2 Migration Guide  <br><br>- [ ] Create `docs/MIGRATION_TO_CLIENT_SIDE.md`\n- [ ] Document breaking changes (none)\n- [ ] Document new features\n- [ ] Provide code examples\n- [ ] List deprecations (old endpoint)\n- [ ] Provide rollback procedure  <br><br>**Checklist**:\n- [ ] Migration guide written\n- [ ] Backwards compatibility confirmed\n- [ ] Examples tested with actual API\n- [ ] Shared with team/users  <br><br>### 4.3 Runbook & Troubleshooting  <br><br>- [ ] Create `docs/TROUBLESHOOTING_CLIENT_ZONES.md`\n- [ ] Document common issues\n- [ ] Provide diagnostic commands\n- [ ] Recovery procedures\n- [ ] Performance tuning tips  <br><br>**Common Issues to Document**:\n- [ ] Slow zone filtering (>200ms)\n- [ ] Missing zones in response\n- [ ] Incorrect penalty scores\n- [ ] Frontend dropdown not populating\n- [ ] OSRM connection errors  <br><br>---  <br><br>## Phase 5: Monitoring & Optimization (Week 3-4)  <br><br>### 5.1 Metrics Collection  <br><br>- [ ] Add latency metrics for `check_route_intersections()`\n- [ ] Track route count by avoid mode\n- [ ] Monitor cache hit rates (if caching added)\n- [ ] Track zone version distribution\n- [ ] Log errors and exceptions  <br><br>```python\nimport time\nfrom functools import wraps\n\ndef timer_decorator(name):\n    def decorator(func):\n        @wraps(func)\n        async def wrapper(*args, **kwargs):\n            start = time.time()\n            result = await func(*args, **kwargs)\n            duration = time.time() - start\n            logger.info(f\"{name} took {duration*1000:.1f}ms\")\n            return result\n        return wrapper\n    return decorator\n\n@app.get(\"/route/v1/driving/{coordinates}\")\n@timer_decorator(\"route_with_zones\")\nasync def route_with_zones(...):\n    ...\n```  <br><br>**Checklist**:\n- [ ] Latency metrics logged\n- [ ] Errors tracked\n- [ ] No performance degradation\n- [ ] Metrics exported to monitoring system  <br><br>### 5.2 Load Testing  <br><br>- [ ] Create `tests/load_test_zones.py` using `locust`\n- [ ] Simulate 10 concurrent users routing\n- [ ] Simulate 100 concurrent users\n- [ ] Simulate zone version switching\n- [ ] Monitor server resource usage  <br><br>```bash\n# Install locust\npip install locust\n\n# Run load test\nuv run locust -f tests/load_test_zones.py --host=http://localhost:9090\n```  <br><br>**Checklist**:\n- [ ] 10 concurrent users: <500ms response time\n- [ ] 100 concurrent users: <1s response time\n- [ ] CPU usage <50% of capacity\n- [ ] Memory usage stable\n- [ ] No connection timeouts  <br><br>### 5.3 Optimization Opportunities  <br><br>- [ ] Profile `check_route_intersections()` with cProfile\n- [ ] Identify bottlenecks\n- [ ] Consider caching spatial indexes\n- [ ] Consider polygon simplification\n- [ ] Benchmark with production-size Brazil PBF zones  <br><br>```bash\n# Profile the function\nuv run python -m cProfile -s cumulative tests/profile_zones.py\n```  <br><br>**Optimization Checklist**:\n- [ ] STRtree creation is fast (<5ms)\n- [ ] Intersection checking is fast (<100ms)\n- [ ] Memory usage is reasonable (<100MB)\n- [ ] No unnecessary object allocations  <br><br>---  <br><br>## Phase 6: Deployment & Rollout (Week 4)  <br><br>### 6.1 Staging Deployment  <br><br>- [ ] Deploy to staging environment\n- [ ] Run full integration test suite\n- [ ] Verify with sample zone configs\n- [ ] Performance test with production data\n- [ ] Security audit (input validation)  <br><br>**Checklist**:\n- [ ] Staging deployment successful\n- [ ] All tests pass\n- [ ] No errors in logs\n- [ ] Response times acceptable\n- [ ] Security review completed  <br><br>### 6.2 Production Deployment  <br><br>- [ ] Create deployment PR with all changes\n- [ ] Code review by team member\n- [ ] Update version/changelog\n- [ ] Deploy to production (low-traffic window)\n- [ ] Monitor error rates\n- [ ] Monitor response times  <br><br>**Deployment Steps**:  <br><br>```bash\n# 1. Create feature branch\ngit checkout -b feature/client-side-zones\n\n# 2. Make changes (Phase 1-5 work)\n\n# 3. Run all tests\nuv run pytest tests/ -v\n\n# 4. Create PR\ngit push origin feature/client-side-zones\n\n# 5. After review and merge\ngit checkout main\ngit pull\n\n# 6. Tag release\ngit tag -a v2.0.0 -m \"Add client-side avoid zones\"\ngit push origin v2.0.0\n\n# 7. Build and deploy\ndocker-compose build avoidzones\ndocker-compose up -d avoidzones\n```  <br><br>**Checklist**:\n- [ ] Code reviewed and approved\n- [ ] Version number bumped\n- [ ] Changelog updated\n- [ ] Docker image built successfully\n- [ ] Old Docker image backed up\n- [ ] Deployment completed without errors\n- [ ] No production alerts triggered  <br><br>### 6.3 Post-Deployment Monitoring  <br><br>**First 24 Hours**:\n- [ ] Monitor error rate (should be 0%)\n- [ ] Monitor response time (should be <500ms)\n- [ ] Check logs for exceptions\n- [ ] Verify zone filtering works\n- [ ] Monitor disk space  <br><br>**First Week**:\n- [ ] Collect latency metrics\n- [ ] Compare to benchmarks\n- [ ] Check resource usage trends\n- [ ] Gather user feedback\n- [ ] Monitor for edge cases  <br><br>**Checklist**:\n- [ ] No unexpected errors\n- [ ] Performance meets targets\n- [ ] Users report satisfaction\n- [ ] No resource exhaustion\n- [ ] Rollback procedure available  <br><br>---  <br><br>## Phase 7: Cleanup & Deprecation (Week 4+)  <br><br>### 7.1 Old System Deprecation  <br><br>- [ ] Mark `/avoidzones/apply` as deprecated\n- [ ] Add deprecation warnings to logs\n- [ ] Notify users of sunsetting date\n- [ ] Provide migration window (3-6 months)\n- [ ] Document alternative workflow  <br><br>**Deprecation Notice**:\n```python\n@app.post(\"/avoidzones/apply\", deprecated=True)\nasync def apply_avoidzones(...):\n    logger.warning(\n        \"DEPRECATED: /avoidzones/apply will be removed 2025-06-01. \"\n        \"Use new client-side zones filtering instead.\"\n    )\n    # Keep functioning but warn users\n```  <br><br>**Checklist**:\n- [ ] Deprecation message added\n- [ ] Users notified via changelog\n- [ ] Documentation updated\n- [ ] Sunsetting date announced  <br><br>### 7.2 Documentation Cleanup  <br><br>- [ ] Remove outdated PBF reprocessing docs\n- [ ] Consolidate zone documentation\n- [ ] Archive old approaches in `docs/ARCHIVED/`\n- [ ] Update README with new architecture\n- [ ] Update deployment guide  <br><br>**Checklist**:\n- [ ] Old docs archived\n- [ ] New docs complete\n- [ ] README updated\n- [ ] Deployment guide current\n- [ ] Examples tested  <br><br>### 7.3 Performance Analysis Report  <br><br>- [ ] Collect metrics from first month\n- [ ] Generate performance report\n- [ ] Compare to server-side baseline\n- [ ] Document improvements\n- [ ] Identify remaining optimization opportunities  <br><br>**Report Should Include**:\n- [ ] Average response time improvement\n- [ ] Resource usage reduction\n- [ ] Concurrent request handling capacity\n- [ ] Error rate comparison\n- [ ] User satisfaction metrics  <br><br>---  <br><br>## Success Criteria  <br><br>The migration is successful when:  <br><br>✅ **Performance**\n- Route latency < 500ms (vs 15-30min)\n- 10+ concurrent requests with no queuing\n- Server CPU usage constant regardless of client count  <br><br>✅ **Functionality**\n- Zone filtering works correctly\n- Historical zones retrievable and reusable\n- All route modes functional  <br><br>✅ **Reliability**\n- <0.1% error rate\n- No data loss of zone history\n- Proper error handling for edge cases  <br><br>✅ **User Experience**\n- UI responsive and intuitive\n- Clear zone version selection\n- Penalty visualization helpful  <br><br>✅ **Operations**\n- No manual intervention required\n- Monitoring and alerting in place\n- Documentation complete  <br><br>---  <br><br>## Risk Mitigation  <br><br>| Risk | Mitigation |\n|------|------------|\n| Routing quality degradation | Extensive testing before launch; keep old system as fallback |\n| High latency spikes | Load testing; caching; performance optimization |\n| Zone history corruption | Versioned snapshots; checksums; backup strategy |\n| Frontend bugs | Thorough testing; cross-browser compatibility |\n| OSRM connection issues | Timeout handling; error logging; fallback behavior |  <br><br>---  <br><br>## Rollback Procedure  <br><br>If issues arise, rollback in <5 minutes:  <br><br>```bash\n# 1. Identify issue via monitoring/logs\n# 2. Revert to previous Docker image\ndocker-compose down\ngit checkout v1.9.0  # Previous version tag\ndocker-compose build avoidzones\ndocker-compose up -d avoidzones\n\n# 3. Verify old endpoint works\ncurl http://localhost:9090/avoidzones/history\n\n# 4. Notify users\n# 5. Investigate root cause post-incident\n```  <br><br>---  <br><br>## Appendix: Command Reference  <br><br>```bash\n# Development\nuv run pytest tests/ -v                    # Run all tests\nuv run pytest tests/test_zones.py -v       # Run specific test file\nuv run pytest -k \"test_latency\" --profile # Run with profiling\n\n# Local testing\nuv run uvicorn src.webrotas.app:app --reload --port 9090\n\n# Docker\ndocker-compose build avoidzones           # Rebuild image\ndocker-compose up -d avoidzones           # Start service\ndocker-compose logs -f avoidzones         # View logs\n\n# Performance\nuv run python -m cProfile -s cumulative tests/profile_zones.py\n\n# Load testing\nuv run locust -f tests/load_test.py --host=http://localhost:9090\n```  <br><br>---  <br><br>## Questions & Support  <br><br>For questions during implementation:\n- Review `docs/CLIENT_SIDE_AVOID_ZONES_RESEARCH.md` for detailed technical info\n- Check `docs/API.md` for endpoint specifications\n- Consult `docs/TROUBLESHOOTING_CLIENT_ZONES.md` for common issues\n"